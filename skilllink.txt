import 'package:flutter/material.dart';

void main() => runApp(SkillLinkApp());

class SkillLinkApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'SkillLink',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        fontFamily: 'Roboto',
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.indigoAccent),
        useMaterial3: true,
      ),
      home: LoginScreen(),
    );
  }
}

// ------------------- LOGIN SCREEN -------------------
class LoginScreen extends StatefulWidget {
  @override
  _LoginScreenState createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> {
  final _formKey = GlobalKey<FormState>();
  String username = "";
  String email = "";

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            colors: [Color(0xFF4A00E0), Color(0xFF8E2DE2)],
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
          ),
        ),
        child: Center(
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(24),
            child: Card(
              shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(20)),
              elevation: 8,
              child: Padding(
                padding: const EdgeInsets.all(24),
                child: Form(
                  key: _formKey,
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Icon(Icons.handshake, size: 90, color: Colors.indigoAccent),
                      const SizedBox(height: 10),
                      Text(
                        "SkillLink",
                        style: TextStyle(
                            fontSize: 28,
                            fontWeight: FontWeight.bold,
                            color: Colors.indigoAccent),
                      ),
                      const SizedBox(height: 30),
                      TextFormField(
                        decoration: InputDecoration(
                          labelText: "Username",
                          border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(12)),
                        ),
                        validator: (v) =>
                            v!.isEmpty ? "Please enter username" : null,
                        onSaved: (v) => username = v!,
                      ),
                      const SizedBox(height: 16),
                      TextFormField(
                        decoration: InputDecoration(
                          labelText: "Email",
                          border: OutlineInputBorder(
                              borderRadius: BorderRadius.circular(12)),
                        ),
                        validator: (v) =>
                            v!.isEmpty ? "Please enter email" : null,
                        onSaved: (v) => email = v!,
                      ),
                      const SizedBox(height: 24),
                      ElevatedButton(
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.indigoAccent,
                          foregroundColor: Colors.white,
                          minimumSize: const Size(double.infinity, 50),
                          shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(12)),
                        ),
                        onPressed: () {
                          if (_formKey.currentState!.validate()) {
                            _formKey.currentState!.save();
                            Navigator.pushReplacement(
                              context,
                              MaterialPageRoute(
                                  builder: (_) => MainApp(
                                      username: username, email: email)),
                            );
                          }
                        },
                        child: const Text("Login / Sign Up",
                            style: TextStyle(fontSize: 18)),
                      ),
                    ],
                  ),
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}

// ------------------- MAIN APP -------------------
class MainApp extends StatefulWidget {
  final String username;
  final String email;
  const MainApp({required this.username, required this.email});

  @override
  _MainAppState createState() => _MainAppState();
}

class _MainAppState extends State<MainApp> {
  int _selectedIndex = 0;

  List<Map<String, dynamic>> matches = [
    {"name": "Aarav Sharma", "skills": ["Flutter", "Firebase"], "accepted": false},
    {"name": "Neha Patel", "skills": ["Python", "ML"], "accepted": false},
    {"name": "Ravi Kumar", "skills": ["React", "Node.js"], "accepted": false},
    {"name": "Ananya Iyer", "skills": ["Java", "Spring Boot"], "accepted": false},
    {"name": "Sanya Mehta", "skills": ["UI/UX", "Figma"], "accepted": false},
  ];

  List<String> teachSkills = ["Flutter", "Python"];
  List<String> learnSkills = ["React", "AI"];

  @override
  Widget build(BuildContext context) {
    List<Map<String, dynamic>> acceptedMentors =
        matches.where((m) => m["accepted"] == true).toList();

    return Scaffold(
      appBar: AppBar(
        title: const Text("SkillLink",
            style: TextStyle(fontWeight: FontWeight.bold)),
        backgroundColor: Colors.indigoAccent,
        foregroundColor: Colors.white,
        centerTitle: true,
      ),
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            colors: [Color(0xFFE0EAFC), Color(0xFFCFDEF3)],
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
          ),
        ),
        child: IndexedStack(
          index: _selectedIndex,
          children: [
            HomeScreen(username: widget.username),
            MatchScreen(
              matches: matches,
              onAccept: (index) {
                setState(() {
                  matches[index]["accepted"] = true;
                });
              },
            ),
            ChatScreen(acceptedMentors: acceptedMentors),
            ProfileScreen(
              username: widget.username,
              email: widget.email,
              teachSkills: teachSkills,
              learnSkills: learnSkills,
              onAddTeach: (skill) {
                setState(() => teachSkills.add(skill));
              },
              onAddLearn: (skill) {
                setState(() => learnSkills.add(skill));
              },
            ),
          ],
        ),
      ),
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: _selectedIndex,
        backgroundColor: Colors.white,
        elevation: 6,
        selectedItemColor: Colors.indigoAccent,
        unselectedItemColor: Colors.grey,
        type: BottomNavigationBarType.fixed,
        onTap: (i) => setState(() => _selectedIndex = i),
        items: const [
          BottomNavigationBarItem(icon: Icon(Icons.home), label: "Home"),
          BottomNavigationBarItem(icon: Icon(Icons.people), label: "Matches"),
          BottomNavigationBarItem(icon: Icon(Icons.chat), label: "Chats"),
          BottomNavigationBarItem(icon: Icon(Icons.person), label: "Profile"),
        ],
      ),
    );
  }
}

// ------------------- HOME SCREEN -------------------
class HomeScreen extends StatelessWidget {
  final String username;
  const HomeScreen({required this.username});

  @override
  Widget build(BuildContext context) {
    return Center(
      child: Padding(
        padding: const EdgeInsets.all(24),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(Icons.handshake, size: 90, color: Colors.indigoAccent),
            const SizedBox(height: 20),
            Text("Welcome, $username ðŸ‘‹",
                style:
                    TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),
            const SizedBox(height: 8),
            Text("Connect. Learn. Teach.",
                style: TextStyle(fontSize: 16, color: Colors.grey[700])),
          ],
        ),
      ),
    );
  }
}

// ------------------- MATCH SCREEN -------------------
class MatchScreen extends StatelessWidget {
  final List<Map<String, dynamic>> matches;
  final Function(int) onAccept;
  const MatchScreen({required this.matches, required this.onAccept});

  @override
  Widget build(BuildContext context) {
    return ListView.builder(
      itemCount: matches.length,
      padding: const EdgeInsets.all(10),
      itemBuilder: (context, i) {
        final m = matches[i];
        return Card(
          shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(12)),
          elevation: 4,
          margin: const EdgeInsets.symmetric(vertical: 8, horizontal: 10),
          child: ListTile(
            leading: CircleAvatar(
                // Fix: Replaced withOpacity with withAlpha to address deprecation.
                backgroundColor: Colors.indigoAccent.withAlpha(51), // 20% of 255 (full alpha) is 51
                child: const Icon(Icons.person, color: Colors.indigoAccent)),
            title: Text(m["name"],
                style: const TextStyle(fontWeight: FontWeight.bold)),
            subtitle: Text("Skills: ${m["skills"].join(', ')}"),
            trailing: m["accepted"]
                ? ElevatedButton(
                    style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.green),
                    onPressed: null,
                    child: const Text("Accepted",
                        style: TextStyle(color: Colors.white)),
                  )
                : ElevatedButton(
                    style: ElevatedButton.styleFrom(
                      backgroundColor: Colors.indigoAccent,
                      foregroundColor: Colors.white,
                    ),
                    onPressed: () => onAccept(i),
                    child: const Text("Accept"),
                  ),
          ),
        );
      },
    );
  }
}

// ------------------- CHAT SCREEN -------------------
class ChatScreen extends StatelessWidget {
  final List<Map<String, dynamic>> acceptedMentors;
  const ChatScreen({required this.acceptedMentors});

  @override
  Widget build(BuildContext context) {
    if (acceptedMentors.isEmpty) {
      return const Center(
          child: Text("No mentors accepted yet.",
              style: TextStyle(fontSize: 16, color: Colors.black54)));
    }
    return ListView.builder(
      itemCount: acceptedMentors.length,
      padding: const EdgeInsets.all(10),
      itemBuilder: (context, i) {
        final m = acceptedMentors[i];
        return Card(
          shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(12)),
          elevation: 3,
          margin: const EdgeInsets.symmetric(vertical: 8, horizontal: 10),
          child: ListTile(
            leading: CircleAvatar(
                // Fix: Replaced withOpacity with withAlpha to address deprecation.
                backgroundColor: Colors.indigoAccent.withAlpha(51), // 20% of 255 (full alpha) is 51
                child: const Icon(Icons.person, color: Colors.indigoAccent)),
            title: Text(m["name"]),
            subtitle: const Text("Tap to chat"),
            trailing: const Icon(Icons.chat_bubble_outline,
                color: Colors.indigoAccent),
          ),
        );
      },
    );
  }
}

// ------------------- PROFILE SCREEN -------------------
class ProfileScreen extends StatelessWidget {
  final String username;
  final String email;
  final List<String> teachSkills;
  final List<String> learnSkills;
  final Function(String) onAddTeach;
  final Function(String) onAddLearn;

  const ProfileScreen({
    required this.username,
    required this.email,
    required this.teachSkills,
    required this.learnSkills,
    required this.onAddTeach,
    required this.onAddLearn,
  });

  void _addSkillDialog(BuildContext context, String title, Function(String) add) {
    final c = TextEditingController();
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: Text(title),
        content: TextField(
          controller: c,
          decoration: const InputDecoration(hintText: "Enter skill"),
        ),
        actions: [
          TextButton(onPressed: () => Navigator.pop(context), child: const Text("Cancel")),
          ElevatedButton(
            onPressed: () {
              if (c.text.trim().isNotEmpty) {
                add(c.text.trim());
                Navigator.pop(context);
              }
            },
            child: const Text("Add"),
          )
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(24),
      child: Column(crossAxisAlignment: CrossAxisAlignment.start, children: [
        Center(
          child: Column(children: [
            CircleAvatar(
              radius: 45,
              // Fix: Replaced withOpacity with withAlpha to address deprecation.
              backgroundColor: Colors.indigoAccent.withAlpha(51), // 20% of 255 (full alpha) is 51
              child: const Icon(Icons.person, size: 60, color: Colors.indigoAccent),
            ),
            const SizedBox(height: 10),
            Text(username,
                style: const TextStyle(
                    fontSize: 22, fontWeight: FontWeight.bold)),
            Text(email, style: TextStyle(color: Colors.grey[600])),
          ]),
        ),
        const SizedBox(height: 30),
        Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [
          const Text("Skills I Can Teach",
              style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
          IconButton(
            icon: const Icon(Icons.add_circle, color: Colors.indigoAccent),
            onPressed: () =>
                _addSkillDialog(context, "Add a Skill to Teach", onAddTeach),
          ),
        ]),
        Wrap(spacing: 8, children: [
          for (var s in teachSkills) SkillChip(label: s),
        ]),
        const SizedBox(height: 20),
        Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [
          const Text("Skills I Want to Learn",
              style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
          IconButton(
            icon: const Icon(Icons.add_circle, color: Colors.indigoAccent),
            onPressed: () =>
                _addSkillDialog(context, "Add a Skill to Learn", onAddLearn),
          ),
        ]),
        Wrap(spacing: 8, children: [
          for (var s in learnSkills) SkillChip(label: s),
        ]),
      ]),
    );
  }
}

class SkillChip extends StatelessWidget {
  final String label;
  const SkillChip({required this.label});

  @override
  Widget build(BuildContext context) {
    return Chip(
      label: Text(label, style: const TextStyle(color: Colors.indigoAccent)),
      backgroundColor: Colors.white,
      elevation: 2,
      // Fix: Replaced withOpacity with withAlpha to address deprecation.
      shadowColor: Colors.indigoAccent.withAlpha(76), // 30% of 255 is 76.5, rounded to 76
    );
  }
}